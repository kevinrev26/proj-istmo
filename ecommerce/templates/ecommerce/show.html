{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="product-detail py-5">
  <div class="container">
    <div class="row">
      <!-- Product Images Column -->
      <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm rounded-3 overflow-hidden mb-3">
          <img src="{{ template_data.product.image.url }}" 
               class="img-fluid main-product-image" 
               alt="{{ template_data.product.name }}"
               id="mainProductImage">
        </div>
        <div class="thumbnail-container d-flex gap-2">
          <!-- You could add thumbnail images here if you have multiple product images -->
          <div class="thumbnail active" onclick="changeMainImage(this)">
            <img src="{{ template_data.product.image.url }}" 
                 class="img-thumbnail" 
                 alt="Thumbnail 1">
          </div>
          <!-- Add more thumbnails if available -->
        </div>
      </div>

      <!-- Product Info Column -->
      <div class="col-lg-6">
        <h1 class="fw-bold mb-3">{{ template_data.product.name }}</h1>
        
        <div class="d-flex align-items-center mb-3">
          <div class="product-rating text-warning me-2">
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="far fa-star"></i>
          </div>
          <a href="#reviews" class="text-muted small">(Ver {{ template_data.reviews|length }} reseñas)</a>
        </div>

        <div class="product-price mb-4">
          <span class="h3 text-primary fw-bold">${{ template_data.product.price }}</span>
          {% if template_data.product.old_price %}
          <span class="text-muted text-decoration-line-through ms-2">${{ template_data.product.old_price }}</span>
          {% endif %}
        </div>

        <div class="product-description mb-4">
          <h5 class="fw-bold mb-2">Descripción</h5>
          <p class="mb-0">{{ template_data.product.description }}</p>
        </div>

        <form method="post" action="{% url 'cart.add' id=template_data.product.id %}" class="mb-5">
          {% csrf_token %}
          <div class="row g-2 align-items-center">
            <div class="col-auto">
              <label for="quantity" class="form-label fw-bold">Cantidad:</label>
            </div>
            <div class="col-auto">
              <div class="input-group quantity-selector">
                <button type="button" class="btn btn-outline-secondary decrease-qty">-</button>
                <input type="number" min="1" max="10" class="form-control text-center quantity-input" 
                       name="quantity" value="1" id="quantity">
                <button type="button" class="btn btn-outline-secondary increase-qty">+</button>
              </div>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-primary btn-lg px-4 py-2">
                <i class="fas fa-cart-plus me-2"></i> Añadir al carrito
              </button>
            </div>
          </div>
        </form>

        <div class="product-meta mb-4">
          <div class="d-flex gap-4">
            <div class="d-flex align-items-center">
              <i class="fas fa-shield-alt text-primary me-2"></i>
              <span>Garantía de 1 año</span>
            </div>
            <div class="d-flex align-items-center">
              <i class="fas fa-truck text-primary me-2"></i>
              <span>Envío gratis en El Salvador</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="row mt-5" id="reviews">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="fw-bold mb-0">Reseñas</h2>
          <span class="badge bg-primary rounded-pill">{{ template_data.reviews|length }} reseñas</span>
        </div>
        <hr>

        {% if template_data.reviews %}
        <div class="review-list mb-5">
          {% for review in template_data.reviews %}
          <div class="card border-0 shadow-sm rounded-3 mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <div>
                  <h5 class="mb-1 fw-bold">{{ review.user.username }}</h5>
                  <div class="text-warning small">
                    {% for i in "12345" %}
                      {% if forloop.counter <= review.rating %}
                        <i class="fas fa-star"></i>
                      {% else %}
                        <i class="far fa-star"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
                <span class="text-muted small">{{ review.date|date:"F d, Y" }}</span>
              </div>
              <p class="mb-0">{{ review.comment }}</p>
              
              {% if user.is_authenticated and user == review.user %}
              <div class="mt-3">
                <a href="{% url 'ecommerce.edit_review' id=template_data.product.id review_id=review.id %}" 
                   class="btn btn-sm btn-outline-primary me-2">
                  <i class="fas fa-edit me-1"></i> Editar
                </a>
                <a href="{% url 'ecommerce.delete_review' id=template_data.product.id review_id=review.id %}" 
                   class="btn btn-sm btn-outline-danger">
                  <i class="fas fa-trash-alt me-1"></i> Eliminar
                </a>
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="far fa-comment-dots fa-3x text-muted mb-3"></i>
          <h5 class="mb-2">No hay reseñas todavía</h5>
          <p class="text-muted">Sé el primero en opinar sobre este producto</p>
        </div>
        {% endif %}

        {% if user.is_authenticated %}
        <div class="card border-0 shadow-sm rounded-3">
          <div class="card-body p-4">
            <h4 class="fw-bold mb-4">Escribe tu reseña</h4>
            <form method="POST" action="{% url 'ecommerce.create_review' id=template_data.product.id %}">
              {% csrf_token %}
              <div class="mb-3">
                <label for="rating" class="form-label fw-bold">Calificación:</label>
                <div class="rating-stars">
                  {% for i in "54321" %}
                  <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" {% if forloop.first %}checked{% endif %}>
                  <label for="star{{ i }}"><i class="fas fa-star"></i></label>
                  {% endfor %}
                </div>
              </div>
              <div class="mb-3">
                <label for="comment" class="form-label fw-bold">Comentario:</label>
                <textarea name="comment" id="comment" class="form-control" rows="4" required></textarea>
              </div>
              <button type="submit" class="btn btn-primary px-4 py-2">
                <i class="fas fa-paper-plane me-2"></i> Publicar reseña
              </button>
            </form>
          </div>
        </div>
        {% else %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <a href="{% url 'accounts.login' %}?next={{ request.path }}" class="alert-link">Inicia sesión</a> para dejar una reseña
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  // Quantity selector functionality
  document.querySelector('.decrease-qty').addEventListener('click', function() {
    const input = document.querySelector('.quantity-input');
    if (parseInt(input.value) > 1) {
      input.value = parseInt(input.value) - 1;
    }
  });
  
  document.querySelector('.increase-qty').addEventListener('click', function() {
    const input = document.querySelector('.quantity-input');
    if (parseInt(input.value) < 10) {
      input.value = parseInt(input.value) + 1;
    }
  });
  
  // Change main product image when clicking thumbnails
  function changeMainImage(thumbnail) {
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    thumbnail.classList.add('active');
    const newSrc = thumbnail.querySelector('img').src;
    document.getElementById('mainProductImage').src = newSrc;
  }
</script>
{% endblock %}